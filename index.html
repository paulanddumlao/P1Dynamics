<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>P1 Reaction Time Game</title>
  <style>
    body {
      background: #000;
      color: #fff;
      font-family: Arial, sans-serif;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100vh;
      margin: 0;
      position: relative;
    }
    #logo {
      position: absolute;
      top: 15px;
      left: 50%;
      transform: translateX(-50%);
      width: 150px;
      z-index: 15;
    }
    #instr {
      margin-bottom: 20px;
      font-size: 1.2em;
    }
    #lights {
      display: flex;
      gap: 20px;
    }
    .light {
      width: 60px;
      height: 60px;
      border: 3px solid #ffffff77;
      background: #444;
      border-radius: 50%;
    }
    #result {
      margin-top: 30px;
      font-size: 1.4em;
      visibility: hidden;
    }
    #retry {
      margin-top: 15px;
      padding: 8px 16px;
      font-size: 1em;
      cursor: pointer;
      display: none;
    }
  </style>
</head>
<body>
  <img id="logo" src="P1dynamicslogo.png" alt="P1 Dynamics Logo">
  <div id="instr"></div>
  <div id="lights">
    <div class="light"></div>
    <div class="light"></div>
    <div class="light"></div>
    <div class="light"></div>
    <div class="light"></div>
  </div>
  <div id="result"></div>
  <button id="retry">Try Again</button>

  <script>
    const instr = document.getElementById('instr');
    const lights = Array.from(document.querySelectorAll('.light'));
    const result = document.getElementById('result');
    const retry = document.getElementById('retry');

    let goTime = null;
    const inputEvents = ['keydown', 'mousedown', 'touchstart'];

    // Utility: add listener once for multiple event types
    function addOnce(elem, handler) {
      inputEvents.forEach(ev => elem.addEventListener(ev, handler, { once: true }));
    }

    // Utility: wait for either barcode event or timeout
    function waitForInput(ms) {
      return new Promise(resolve => {
        let done = false;
        const onInput = e => {
          // If keydown, only accept Space
          if (e.type === 'keydown' && e.code !== 'Space') return;
          if (!done) {
            done = true;
            cleanup();
            resolve(true);
          }
        };
        const timeout = setTimeout(() => {
          if (!done) {
            done = true;
            cleanup();
            resolve(false);
          }
        }, ms);
        inputEvents.forEach(ev => window.addEventListener(ev, onInput));
        function cleanup() {
          clearTimeout(timeout);
          inputEvents.forEach(ev => window.removeEventListener(ev, onInput));
        }
      });
    }

    // Wait specifically for reaction input (Space or tap)
    function waitForReact() {
      return new Promise(resolve => {
        const onInput = e => {
          if (e.type === 'keydown' && e.code !== 'Space') return;
          window.removeEventListener('keydown', onInput);
          window.removeEventListener('mousedown', onInput);
          window.removeEventListener('touchstart', onInput);
          const rt = ((performance.now() - goTime) / 1000).toFixed(3);
          resolve(rt);
        };
        window.addEventListener('keydown', onInput);
        window.addEventListener('mousedown', onInput);
        window.addEventListener('touchstart', onInput);
      });
    }

    // 1. Initial setup: wait for start input
    function init() {
      instr.textContent = 'Tap screen or press space bar to start';
      result.style.visibility = 'hidden';
      retry.style.display = 'none';
      lights.forEach(l => l.style.background = '#444');

      addOnce(window, e => {
        if (e.type === 'keydown' && e.code !== 'Space') return;
        startGame();
      });
    }

    // 2. Begin the light sequence after random delay ≤5s
    function startGame() {
      instr.textContent = 'Get Ready… Don’t tap until lights go off';
      lights.forEach(l => l.style.background = '#444');

      setTimeout(lightSequence, Math.random() * 5000);
    }

    // 3. Light & reaction logic
    async function lightSequence() {
      instr.textContent = '...';
      // Lights on one-by-one
      for (let i = 0; i < lights.length; i++) {
        if (await waitForInput(Math.random() * 1500 + 500)) return jump();
        lights[i].style.background = 'red';
      }
      // Final GO delay
      if (await waitForInput(Math.random() * 2000 + 1000)) return jump();

      // GO state
      lights.forEach(l => l.style.background = '#444');
      instr.textContent = 'GO! Tap or press space bar NOW!';
      goTime = performance.now();
      const reaction = await waitForReact();
      showResult(`${reaction} seconds`);
    }

    function jump() {
      showResult('Jump Start! Wait for lights to go off.');
    }

    function showResult(text) {
      instr.textContent = '';
      result.textContent = text;
      result.style.visibility = 'visible';
      retry.style.display = 'inline-block';
      // Restart on input
      addOnce(window, e => {
        if (e.type === 'keydown' && e.code !== 'Space') return;
        init();
      });
    }

    retry.addEventListener('click', init);
    window.addEventListener('load', init);
  </script>
</body>
</html>
